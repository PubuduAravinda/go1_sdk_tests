import time
import numpy as np
import robot_interface as sdk
import sys

# ─── CONFIG ─────────────────────────────────────────────────────────────────
KP_START = 5.0
KD_FIXED = 3.0
KP_STEP = 5.0
RAMP_INTERVAL_SECONDS = 3.0
RAMP_MAX_LEVEL = 10

scale = 1.0  # fixed

# Real stand pose (default_q)
stand_q = np.array([0.0, 0.77, -1.5, 0.0, 0.77, -1.5, 0.0, 0.77, -1.5, 0.0, 0.77, -1.5])

# Short joint names
joint_names = ["FL_hip", "FR_hip", "RL_hip", "RR_hip", "FL_th", "FR_th", "RL_th", "RR_th", "FL_cal", "FR_cal", "RL_cal", "RR_cal"]


# Sequence: backward-right balance adjustment + initial FL lift to clear ground + bend knee (calf more negative) + hold + swing thigh forward (negative delta on FL_th) + hold + retract + unbend knee + stabilize
# Balance deltas changed: FR_cal -0.15 (lengthen front), RL_cal 0.10 (shorten left rear), RR_cal -0.10 (lengthen right rear) to correct forward and right tilt
# FL lift initial: FL_th -0.3, FL_cal -0.5 to shorten leg and lift foot
# Bend increased to FL_cal -1.1 for more lift if needed
crawl_sequence = np.array([
    # 0-4: Backward-right stand stabilize (hold 5 steps)
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],

    # 5-9: Gradual initial FL lift (negative th and cal to shorten/flex leg, lift foot clear of ground)
    [0.00, 0.00, 0.00, 0.00, -0.06, 0.00, 0.00, 0.00, -0.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.12, 0.00, 0.00, 0.00, -0.20, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.18, 0.00, 0.00, 0.00, -0.30, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.24, 0.00, 0.00, 0.00, -0.40, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],

    # 10-19: Hold initial lift (foot up, 10 steps)
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],

    # 20-24: Bend knee further (negative cal delta to -1.1, keep th -0.3 for lift)
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.62, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.74, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.86, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.98, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 25-34: Hold knee bent (10 steps)
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 35-39: Swing thigh forward (more negative th delta to -1.0)
    [0.00, 0.00, 0.00, 0.00, -0.46, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.62, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.78, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.94, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 40-49: Hold forward lifted pose (10 steps)
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -1.10, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 50-54: Retract thigh back (less negative th)
    [0.00, 0.00, 0.00, 0.00, -0.94, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.78, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.62, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.46, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 55-59: Hold retracted
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -1.10, -0.15, 0.10, -0.10],

    # 60-64: Unbend knee (less negative cal back to -0.5)
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.98, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.86, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.74, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.62, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],

    # 65-69: Hold unbent
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.30, 0.00, 0.00, 0.00, -0.50, -0.15, 0.10, -0.10],

    # 70-74: Lower FL back (reverse initial lift)
    [0.00, 0.00, 0.00, 0.00, -0.24, 0.00, 0.00, 0.00, -0.40, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.18, 0.00, 0.00, 0.00, -0.30, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.12, 0.00, 0.00, 0.00, -0.20, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, -0.06, 0.00, 0.00, 0.00, -0.10, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],

    # 75-79: Final stabilize
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
    [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, -0.15, 0.10, -0.10],
])

# crawl_sequence = np.array([
#     # 0-4: Backward stand stabilize (hold 5 steps)
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#
#     # 5-9: Gradual FL lift (thigh flex + calf extend + small abduction for stability)
#     [0.05, 0.00, 0.00, 0.00, 0.15, 0.00, 0.00, 0.00, -0.20, 0.12, -0.12, -0.12],
#     [0.10, 0.00, 0.00, 0.00, 0.30, 0.00, 0.00, 0.00, -0.50, 0.12, -0.12, -0.12],
#     [0.15, 0.00, 0.00, 0.00, 0.40, 0.00, 0.00, 0.00, -0.80, 0.12, -0.12, -0.12],
#     [0.20, 0.00, 0.00, 0.00, 0.48, 0.00, 0.00, 0.00, -0.95, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#
#     # 10-19: Hold lifted high (~10 steps for data recording)
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#
#     # 20-23: Swing forward (increase thigh flexion for protraction, adjust calf to maintain height)
#     [0.25, 0.00, 0.00, 0.00, 0.60, 0.00, 0.00, 0.00, -0.98, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.65, 0.00, 0.00, 0.00, -0.95, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.68, 0.00, 0.00, 0.00, -0.92, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#
#     # 24-28: Hold forward position (5 steps)
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.70, 0.00, 0.00, 0.00, -0.90, 0.12, -0.12, -0.12],
#
#     # 29-32: Retract back (reduce thigh flexion, adjust calf back)
#     [0.25, 0.00, 0.00, 0.00, 0.68, 0.00, 0.00, 0.00, -0.92, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.65, 0.00, 0.00, 0.00, -0.95, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.60, 0.00, 0.00, 0.00, -0.98, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#
#     # 33-37: Hold retracted (back to neutral lift, 5 steps)
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#     [0.25, 0.00, 0.00, 0.00, 0.55, 0.00, 0.00, 0.00, -1.00, 0.12, -0.12, -0.12],
#
#     # 38-44: Reverse/lower gradually (reduce abduction, lower thigh, lift calf back)
#     [0.20, 0.00, 0.00, 0.00, 0.48, 0.00, 0.00, 0.00, -0.95, 0.12, -0.12, -0.12],
#     [0.15, 0.00, 0.00, 0.00, 0.40, 0.00, 0.00, 0.00, -0.80, 0.12, -0.12, -0.12],
#     [0.10, 0.00, 0.00, 0.00, 0.30, 0.00, 0.00, 0.00, -0.50, 0.12, -0.12, -0.12],
#     [0.05, 0.00, 0.00, 0.00, 0.15, 0.00, 0.00, 0.00, -0.20, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.06, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#
#     # 45-49: Final stabilize backward stand
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
#     [0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.00, 0.12, 0.12, -0.12, -0.12],
# ])
# One-leg-at-a-time crawl with little lift/place
# crawl_sequence = np.array([
#     # FL leg: lift
#     [ 0.00,  0.00,  0.00,  0.00,  0.10,  0.00,  0.00,  0.00,  0.15,  0.00,  0.00,  0.00],
#     # FL higher
#     [ 0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00,  0.25,  0.00,  0.00,  0.00],
#     # FL forward
#     [ 0.00,  0.00,  0.00,  0.00,  0.35,  0.00,  0.00,  0.00,  0.15,  0.00,  0.00,  0.00],
#     # FL place
#     [ 0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00, -0.10,  0.00,  0.00,  0.00],
#     # Stabilize FL
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00],
#
#     # FR leg: lift
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.10,  0.00,  0.00,  0.00,  0.15,  0.00,  0.00],
#     # FR higher
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00,  0.25,  0.00,  0.00],
#     # FR forward
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.35,  0.00,  0.00,  0.00,  0.15,  0.00,  0.00],
#     # FR place
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00, -0.10,  0.00,  0.00],
#     # Stabilize FR
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00],
#
#     # RL leg: lift
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.10,  0.00,  0.00,  0.00,  0.15,  0.00],
#     # RL higher
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00,  0.25,  0.00],
#     # RL forward
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.35,  0.00,  0.00,  0.00,  0.15,  0.00],
#     # RL place
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00, -0.10,  0.00],
#     # Stabilize RL
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00],
#
#     # RR leg: lift
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.10,  0.00,  0.00,  0.00,  0.15],
#     # RR higher
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00,  0.25],
#     # RR forward
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.35,  0.00,  0.00,  0.00,  0.15],
#     # RR place
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.20,  0.00,  0.00,  0.00, -0.10],
#     # Final stabilize
#     [ 0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00,  0.00],
# ])

# ─── INITIALIZATION ─────────────────────────────────────────────────────────
udp = sdk.UDP(0xff, 8080, "192.168.123.10", 8007)
safe = sdk.Safety(sdk.LeggedType.Go1)

cmd = sdk.LowCmd()
state = sdk.LowState()

udp.InitCmdData(cmd)

print("\n" + "="*90)
print("MANUAL CRAWL GAIT — PER-STEP TABLE — NO PD ERROR")
print("Starting in 10 seconds...")
print("="*90 + "\n")

time.sleep(10)

step = 0
t0 = time.time()
sequence_idx = 0

while True:
    time.sleep(0.005)  # ~1 s per leg move
    step += 1
    t = time.time() - t0

    try:
        udp.Recv()
        udp.GetRecv(state)
    except Exception as e:
        print(f"UDP RECV ERROR: {e}", flush=True)
        break

    real_joint_pos = np.array([state.motorState[i].q for i in range(12)])
    real_joint_vel = np.array([state.motorState[i].dq for i in range(12)])
    real_joint_tauEst = np.array([state.motorState[i].tauEst for i in range(12)])

    # KP ramp
    current_level = int(t // RAMP_INTERVAL_SECONDS)
    ramp_level = min(RAMP_MAX_LEVEL, current_level)
    current_kp = KP_START + ramp_level * KP_STEP
    current_kd = KD_FIXED

    # ─── MANUAL CRAWL SEQUENCE ──────────────────────────────────────────────
    delta_q = crawl_sequence[sequence_idx % len(crawl_sequence)]
    print('delta_q-->',delta_q)
    sequence_idx += 1

    # Reorder to real order
    real_delta_q = np.zeros(12)
    real_delta_q[0] = delta_q[1]
    real_delta_q[1] = delta_q[5]
    real_delta_q[2] = delta_q[9]
    real_delta_q[3] = delta_q[0]
    real_delta_q[4] = delta_q[4]
    real_delta_q[5] = delta_q[8]
    real_delta_q[6] = delta_q[3]
    real_delta_q[7] = delta_q[7]
    real_delta_q[8] = delta_q[11]
    real_delta_q[9] = delta_q[2]
    real_delta_q[10] = delta_q[6]
    real_delta_q[11] = delta_q[10]

    target_q = stand_q + real_delta_q

    # ─── Send command ───────────────────────────────────────────────────────
    for i in range(12):
        q_cmd = target_q[i]
        cmd.motorCmd[i].mode = 0x0A
        cmd.motorCmd[i].q = q_cmd
        cmd.motorCmd[i].dq = 0.0
        cmd.motorCmd[i].Kp = current_kp
        cmd.motorCmd[i].Kd = current_kd
        cmd.motorCmd[i].tau = 0.0

    # ─── PER-STEP TABLE ─────────────────────────────────────────────────────
    current_step = (sequence_idx - 1) % len(crawl_sequence) + 1
    print(f"t={t:5.1f}s | kp={current_kp:.1f} | Step {current_step}/{len(crawl_sequence)}")
    print(" idx | joint | real_curr_q | delta_q | default_q | target_q | error | real_dq ")
    print("-----|-------|-------------|---------|-----------|----------|-------|---------")
    for i in range(12):
        name = joint_names[i]
        real_curr = real_joint_pos[i]
        delt     = real_delta_q[i]
        default  = stand_q[i]
        targ     = target_q[i]
        err      = targ - real_curr
        dq       = real_joint_vel[i]
        print(f" {i:3d} | {name:5} | {real_curr:+11.3f} | {delt:+7.3f} | {default:+9.3f} | {targ:+8.3f} | {err:+7.3f} | {dq:+7.3f}")

    # Summary with foot forces
    gravity = -np.array(state.imu.accelerometer) / max(np.linalg.norm(state.imu.accelerometer), 0.1)
    tilt = np.degrees(np.sqrt(gravity[0]**2 + gravity[1]**2))
    forces = state.footForce
    print(f"gravity: x={gravity[0]:+5.3f} y={gravity[1]:+5.3f} z={gravity[2]:+5.3f} | tilt={tilt:5.1f}°")
    print(f"Foot forces (N): FL={forces[0]:4.0f} FR={forces[1]:4.0f} RL={forces[2]:4.0f} RR={forces[3]:4.0f}")
    print("-" * 80)

    try:
        udp.SetSend(cmd)
        udp.Send()
    except Exception as e:
        print(f"UDP SEND ERROR: {e}", flush=True)
        break